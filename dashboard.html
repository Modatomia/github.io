<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Modatomía</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1.2/auth0-spa-js.production.js"></script>
    <style>
      .error-message {
        color: #ff6e40;
        background-color: #ffebee;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: "Poppins", sans-serif;
        display: none;
      }

      .loading {
        display: none;
      }

      .module {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .module-title {
        color: #1e3d59;
        font-size: 24px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f5f5f5;
      }

      .admin-banner {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #user-email {
        display: none;
        color: #1e3d59;
        font-family: "Quicksand", sans-serif;
        font-weight: 500;
      }

      .auth-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: "Quicksand", sans-serif;
        font-weight: 600;
        background-color: #ff6e40;
        color: white;
        transition: background-color 0.3s ease;
      }

      .auth-button:hover {
        background-color: #ff5722;
      }

      .welcome-message {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .welcome-message p {
        margin: 0;
        color: #666;
        line-height: 1.6;
      }

      .resources-section,
      .exercises-section {
        margin-top: 30px;
      }

      .resources-section h4,
      .exercises-section h4 {
        color: #1e3d59;
        font-size: 20px;
        margin-bottom: 20px;
      }

      .resources-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .resource-item {
        display: flex;
        align-items: start;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .resource-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-color: #1abc9c;
      }

      .resource-icon {
        font-size: 24px;
        margin-right: 15px;
        color: #1abc9c;
      }

      .resource-details h5 {
        margin: 0 0 5px 0;
        color: #1e3d59;
        font-size: 16px;
      }

      .resource-details p {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
      }

      .resource-link,
      .exercise-link {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        background-color: #1abc9c;
        color: white;
        text-decoration: none;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }

      .resource-link:hover,
      .exercise-link:hover {
        background-color: #16a085;
      }

      .error-module {
        text-align: center;
        padding: 40px;
      }

      .error-module h3 {
        color: #ff6e40;
        margin-bottom: 10px;
      }

      .error-module p {
        color: #666;
      }

      .purchase-date {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="container">
        <div class="logo-title-group">
          <img src="assets/logo.png" alt="Modatomía Logo" class="logo" />
          <h1>Dashboard</h1>
        </div>
        <div class="user-info">
          <span id="user-email"></span>
          <button id="logout" class="auth-button">Cerrar Sesión</button>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="loading" class="loading">
        <div class="loader"></div>
      </div>
      <div id="error" class="error-message"></div>
      <div id="content">
        <!-- El contenido dinámico se cargará aquí -->
      </div>
    </main>

    <script src="js/config.js"></script>
    <script>
      let auth0Client = null;

      function formatDate(dateString) {
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        };
        return new Date(dateString).toLocaleDateString("es-ES", options);
      }

      function showLoading(show = true) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function loadUserContent(userData) {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = ""; // Limpiar contenido existente

        const { isAdmin, courses } = userData;

        // Mostrar banner de admin si aplica
        if (isAdmin) {
          const adminBanner = document.createElement("div");
          adminBanner.className = "module admin-banner";
          adminBanner.innerHTML = `
            <h3 class="module-title">Panel Administrativo</h3>
            <p>Tienes acceso completo a todos los cursos como administrador.</p>
          `;
          contentDiv.appendChild(adminBanner);
        }

        // Cargar módulos de cursos
        courses.forEach((course) => {
          const moduleDiv = document.createElement("div");
          moduleDiv.className = "module";

          let moduleContent = `
            <h3 class="module-title">${course.name}</h3>
            <div class="welcome-message">
              <p>Bienvenido/a al curso.</p>
              ${
                !isAdmin && course.purchaseDate
                  ? `<p class="purchase-date">Fecha de activación: ${formatDate(
                      course.purchaseDate
                    )}</p>`
                  : ""
              }
            </div>
            <div class="resources-section">
              <h4>Contenido del Curso</h4>
              <ul class="resources-list">
                <li class="resource-item">
                  <div class="resource-icon">📚</div>
                  <div class="resource-details">
                    <h5>Material Principal</h5>
                    <p>Accede a todas las lecciones y recursos del curso</p>
                    <a href="#" class="resource-link">Ir al contenido</a>
                  </div>
                </li>
                <li class="resource-item">
                  <div class="resource-icon">📝</div>
                  <div class="resource-details">
                    <h5>Ejercicios Prácticos</h5>
                    <p>Practica lo aprendido con ejercicios guiados</p>
                    <a href="#" class="resource-link">Ver ejercicios</a>
                  </div>
                </li>
                <li class="resource-item">
                  <div class="resource-icon">📹</div>
                  <div class="resource-details">
                    <h5>Videos Tutoriales</h5>
                    <p>Visualiza las clases paso a paso</p>
                    <a href="#" class="resource-link">Ver videos</a>
                  </div>
                </li>
              </ul>
            </div>
          `;

          moduleDiv.innerHTML = moduleContent;
          contentDiv.appendChild(moduleDiv);
        });
      }

      async function initAuth0() {
        showLoading(true);
        const errorDiv = document.getElementById("error");
        errorDiv.style.display = "none";

        try {
          // Inicializar Auth0
          auth0Client = await auth0.createAuth0Client({
            domain: AUTH_CONFIG.domain,
            clientId: AUTH_CONFIG.clientId,
            cacheLocation: "localstorage",
            useRefreshTokens: true,
            authorizationParams: {
              redirect_uri: `${window.location.origin}/callback.html`,
              scope: "openid profile email",
            },
          });

          // Verificar autenticación
          if (!(await auth0Client.isAuthenticated())) {
            await auth0Client.loginWithRedirect({
              authorizationParams: {
                prompt: "select_account", // Forzar selección de cuenta
              },
            });
            return;
          }

          // Obtener usuario
          const user = await auth0Client.getUser();
          if (!user || !user.email) {
            throw new Error("No se pudo obtener la información del usuario");
          }

          // Mostrar email del usuario
          const userEmailElement = document.getElementById("user-email");
          userEmailElement.textContent = user.email;
          userEmailElement.style.display = "block";

          // Verificar acceso
          const token = await auth0Client.getTokenSilently();
          const response = await fetch("/api/verify", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Error verificando acceso");
          }

          const { success, data } = await response.json();
          if (!success) {
            throw new Error(
              data.message || "No tienes acceso a este contenido"
            );
          }

          // Cargar contenido
          loadUserContent(data);

          // Configurar logout
          document.getElementById("logout").onclick = () => {
            auth0Client.logout({
              logoutParams: {
                returnTo: window.location.origin,
              },
            });
          };
        } catch (error) {
          console.error("Error:", error);
          showError(
            error.message ||
              "Ha ocurrido un error. Por favor, intenta nuevamente."
          );
        } finally {
          showLoading(false);
        }
      }

      // Verificar token periódicamente
      setInterval(async () => {
        try {
          if (auth0Client) {
            await auth0Client.getTokenSilently();
          }
        } catch (error) {
          console.error("Error refreshing token:", error);
          window.location.reload();
        }
      }, 1000 * 60 * 30); // Cada 30 minutos

      // Iniciar la aplicación
      window.onload = initAuth0;
    </script>
  </body>
</html>
